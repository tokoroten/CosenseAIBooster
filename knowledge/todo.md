# CosenseAIBooster 開発 TODO リスト

## 現在の課題

- [x] バグ修正：ストア同期の問題
  - [x] chrome.storage.localへの統一（バックエンドとフロントエンドで共通のストレージを使用）
  - [x] バックエンドとフロントエンド間の通信（GET_FRONTEND_SETTINGS）を削除
  - [x] フロントエンドが直接chrome.storage.localから読み取るように変更
  - [x] ストレージ監視イベントをsyncからlocalに変更

- [x] バグ修正：ブラウザ起動時の固まり問題
  - [x] 無限ループバグの修正（ストレージ監視の重複を排除）
  - [x] コンポーネントの依存配列を適切に修正
  - [x] React循環更新の解消

- [x] 音声入力の改善
  - [x] 音声認識のエラーハンドリング強化
  - [x] マイク権限エラー時のユーザー通知ダイアログ追加
  - [x] エラーメッセージの改善

- [x] プロンプト情報更新処理の強化
  - [x] PromptHandler.tsxでのプロンプト読み込みを初回のみから毎回に変更
  - [x] frontend-storeのロード処理を強化（スキップせず強制取得するよう変更）
  - [x] ポップアップメニュー表示時の最新データ取得を確実にする

## 将来的な拡張候補

- [x] デバッグ機能の強化
  - [x] console.log の出力に一貫したプレフィックスを追加
  - [x] フロントエンド側とバックエンド側で区別できるよう整理
  - [x] 全てのログに "[CosenseAIBooster frontend]" または "[CosenseAIBooster backend]" のプレフィックスを追加
    - [x] 完了：フロントエンド側のファイルには "[CosenseAIBooster frontend]" を、バックエンド側のファイルには "[CosenseAIBooster backend]" を追加
    
- [x] CIとリリース自動化
  - [x] GitHub Actions によるビルドと自動リリースのセットアップ
  - [x] タグプッシュ時に拡張機能をビルド、パッケージ化し、GitHub Releasesに自動公開
    
- [x] 新規プロンプト作成時のデフォルト値設定
  - [x] システムプロンプトのデフォルトテキストの確認
  - [x] 確認完了: PromptsTab.tsxの新規作成ボタンクリック時に、すでに「ここにシステムプロンプトを入力してください。\n例：与えられたテキストを要約してください」というデフォルト値が設定されている

- [ ] プロンプトごとの個別設定強化
  - [ ] 各プロンプトごとにモデル選択を可能にする（2025年7月予定）
    - [ ] PromptsTab.tsxにモデル選択ドロップダウンを追加
    - [ ] Prompt型定義にモデルフィールドを追加
    - [ ] APIリクエスト時にプロンプト固有モデルを優先的に使用するロジック
  - [x] 各プロンプトごとの挿入位置設定機能
    - [x] テキスト挿入時の改行処理を改善
      - [x] 'bottom' オプション使用時に、ドキュメント末尾に挿入前の改行追加
      - [x] 'below' オプション使用時に、次の行に挿入するよう改善
  
- [ ] UI/UXの拡張と改善
  - [x] 設定画面のデザイン改善
    - [x] スクロールバーの重複問題修正
    - [x] 「戻る」ボタン削除によるスペース有効活用
    - [x] 「デフォルトプロンプト追加」ボタン位置最適化
    - [x] プロンプト編集ダイアログの全画面表示
    - [x] 編集フォームの2カラムレイアウト導入
    - [x] ラベル名改善（「表示名」「AIプロバイダー」「システムプロンプト」）
  - [ ] プロンプト管理機能の拡充（2025年8月予定）
    - [ ] ドラッグ&ドロップによるプロンプト順序変更
    - [ ] プロンプトのカテゴリ分け機能
    - [ ] ポップアップメニュー内プロンプトのソート機能

- 各種設定やAPI Keyを永続化するようにして。

- マイク入力ボタンの実装
  - 右側にマイクボタンを設置、クリックで音声入力を開始する
  - 音声入力中は、マイクボタンの色を変える
  - 音声入力中は、音声認識の結果をリアルタイムで表示し、確定したタイミングで、textareaのカーソルがある位置に挿入する
    - リアルタイムの表示は、カーソル位置に対してオーバーレイで表示する
  

## 対応中

- [ ] コード品質の向上（2025年6月）
  - [ ] ESLint エラーとワーニングの修正
    - [ ] "Unexpected lexical declaration in case block" エラーの修正 (service.ts)
    - [ ] 未使用変数の削除または活用
    - [ ] `any` 型を`unknown`または明示的な型に変更
    - [ ] 必要なconsole文のみ残し、不要なものを削除（デバッグ用途）
    - [ ] 関数の戻り値の型宣言の追加
  - [ ] TypeScript型定義の強化
    - [ ] インターフェースと型の文書化
    - [ ] 共通型の一元管理
- [x] トップレベルに多くのファイルが転がりすぎているので、フォルダ構造を整理する
  - [x] 不要なファイル（wxt.config.ts.new等）の削除
  - [x] 重複している出力ディレクトリ（dev/.output）の削除
  - [x] srcフォルダ内のコード整理
  - [x] プロジェクト構造を詳細にドキュメント化（knowledge/project-structure.md）
- [x] WXTの作法に従って、過去に作成されたコードを整理していって（src配下は整理済み、トップレベル整理も完了）
- [x] README.mdにビルドの方法と簡易な使い方を書いていく
- [ ] 実験用のボタンを追加して、動作確認をして
- [x] 設定画面のデザインをTailwindでカッコよくして。

- [x] 音声認識の言語を選択可能にする（英語など）
- [x] React、JSX、Tailwind、Zustandを使用してリファクタリング
  - [x] Zustandストアの実装
  - [x] ReactコンポーネントでUIを再実装
  - [x] Reactフレンドリーなユーティリティクラスの作成
- [x] Scrapboxのページメニューに新しいドロップダウンやボタンを追加するユーティリティクラスを作成する
  - [x] 既存のページメニュー（右側のボタン群）と同じスタイルで表示できること
  - [x] ドロップダウンメニュー追加機能
  - [x] 単独ボタン追加機能
  - [x] アイコン付きメニュー項目追加機能
- [x] テキスト選択時のポップアップメニューに機能を追加するためのユーティリティクラスを作成する
  - [x] ポップアップメニューの検出機能
  - [x] ボタン追加機能
  - [x] カスタムスタイルのサポート
  - [x] リムーブ機能

- [ ] ユーザーエクスペリエンス向上（2025年7月）
  - [ ] 初回使用時のチュートリアルモード
    - [ ] APIキー設定ガイド
    - [ ] 基本操作チュートリアル
  - [ ] エラーメッセージの改善
    - [ ] ユーザーフレンドリーなエラー表示
    - [ ] トラブルシューティングガイド
  - [ ] テーマのカスタマイズ
    - [ ] ダークモード対応
    - [ ] カラーテーマ設定

- [ ] パフォーマンス最適化（2025年8月）
  - [ ] レスポンス時間の短縮
    - [ ] ストレージアクセスの効率化
    - [ ] キャッシュ機構の導入
  - [ ] メモリ使用量の最適化
    - [ ] コンポーネントのメモ化
    - [ ] リソース解放の徹底

## 完了済みタスク
- [x] プロジェクトの初期化 (package.json の作成)
- [x] TypeScript の設定 (tsconfig.json)
- [x] ESLint と Prettier の設定
- [x] Chrome 拡張機能のマニフェストファイル (v3) の作成
- [x] ビルドスクリプトの設定 (Webpack)
- [x] プロジェクトディレクトリ構造の作成 (src/, dist/)

## 基本構造の実装
- [x] 拡張機能のアイコンの作成
  - [x] 複数サイズのアイコン (16x16, 32x32, 48x48, 128x128) の作成
- [x] バックグラウンドスクリプトの作成
- [x] コンテンツスクリプトの作成
- [x] Cosense (Scrapbox) ページ検出ロジックの実装
- [x] 右側のアイコン欄へのUI追加機能の実装

## 設定画面の実装
- [x] 設定ページのHTML/CSSの作成
  - [x] Reactコンポーネント化
  - [x] Tailwind CSSによるスタイリング
- [x] ポップアップメニューからの設定アクセス
  - [x] ポップアップ内で設定パネルを直接表示
  - [x] 設定パネルに`isPopup`プロパティを追加し、コンパクト表示に対応
  - [x] レイアウトとサイズの最適化
- [x] プロンプト管理機能の実装
  - [x] プロンプトの追加機能
  - [x] プロンプトの編集機能
  - [x] プロンプトの削除機能
  - [x] プロンプトの保存機能
  - [x] Zustandストアによる状態管理
- [x] プロンプト適用方法の設定
  - [x] 挿入位置設定 (選択範囲の下 or ページの最下部)
  - [x] モデル選択機能の実装
- [x] 音声入力言語設定の実装
- [x] API設定の実装
  - [x] OpenAI APIキー設定
  - [x] OpenRouter APIキー設定
  - [x] カスタムエンドポイント設定
  - [x] LocalLLM 接続設定（オプション）
- [x] 設定の保存と読み込み機能の実装
  - [x] Zustandストアと統合したChrome Storage API利用
  - [x] persistミドルウェアによる永続化

## 音声入力機能の実装
- [x] WebSpeech API を使用した音声認識の実装
  - [x] Reactフレンドリーなラッパーの作成
  - [x] Zustandストアと統合
- [x] 音声入力UIの作成 (マイクアイコン、状態表示)
  - [x] Reactコンポーネントとして実装
  - [x] Tailwind CSSによるスタイリング
- [x] 音声テキストの Cosense への挿入機能
- [x] 音声認識言語の切り替え機能

## プロンプト適用機能の実装
- [x] テキスト選択検出機能の実装
  - [x] Reactイベントハンドリングの統合
- [x] コンテキストメニューの実装
  - [x] 登録済みプロンプトのメニュー表示
  - [x] Reactベースのポップアップメニューコンポーネント
  - [x] プロンプト選択機能
- [x] 選択テキストとプロンプトの処理ロジック実装
  - [x] Zustandストアからのプロンプト取得
- [x] API 呼び出しの実装
  - [x] OpenAI API クライアント
  - [x] OpenRouter API クライアント
  - [x] カスタムエンドポイントクライアント
  - [x] ZustandストアからのAPI設定取得
- [x] 結果の挿入機能の実装
  - [x] 選択範囲の下への挿入ロジック
  - [x] ページ最下部への挿入ロジック
  - [x] Reactフレンドリーなドキュメント操作

## テストとデバッグ
- [x] 音声認識機能の強化
  - [x] 自動再起動機能の実装
  - [x] 一時停止検出機能の実装
  - [x] エラーハンドリングの改善
- [x] テキスト挿入機能の強化
  - [x] 複数行のテキスト挿入対応
  - [x] エディタへの挿入ロジックの改善
- [x] ストレージ関連のバグ修正
  - [x] `StorageService.get is not a function` エラーの修正
  - [x] `Invalid settings detected, using defaults` メッセージの問題修正
  - [x] TypeScriptの構文エラーの修正
- [x] Reactコンポーネントのテスト
  - [x] 不要なファイルの削除
  - [ ] コンポーネントのレンダリングテスト
  - [ ] 状態管理の動作確認
- [ ] ページメニューのユーティリティクラス機能確認
  - [ ] ReactベースのドロップダウンUIコンポーネントのテスト
  - [ ] Reactボタンコンポーネントのテスト
  - [ ] Reactメニュー項目コンポーネントのテスト
  - [ ] Tailwind CSSスタイルの調整とUI整合性確認
- [ ] 各機能の単体テスト
- [ ] 統合テスト
- [ ] Cosense サイト上での動作確認
- [ ] 様々なブラウザ環境でのテスト

## パッケージングとリリース
- [ ] パッケージングスクリプトの作成
- [ ] Chrome ウェブストアへの公開準備
- [ ] ドキュメント作成
  - [ ] Reactコンポーネントの構造に関するドキュメント
  - [ ] Zustandストアの使用法に関するドキュメント

## 追加機能 (オプション)
- [ ] LocalLLM 接続機能の拡張
- [ ] プロンプトのカテゴリ分け
- [ ] プロンプトのインポート/エクスポート機能
- [ ] 複数言語対応
- [ ] Reactコンポーネントのテーマ切り替え機能
- [ ] カスタムフック作成によるロジック改善
- [x] APIキーセキュリティの強化
  - [x] APIキーをバックグラウンドスクリプトでのみ扱うよう変更
  - [x] メッセージパッシングを利用したセキュアな通信の実装
  - [x] コンテンツスクリプトでAPIキーを扱わないように修正

## 現在の問題と解決済み課題

### 解決済み
- [x] バックエンドでの設定変更（新規プロンプトの追加など）がフロントエンドに自動で伝搬されない問題
  - [x] Chromeストレージ変更イベントのリスニング実装
  - [x] リアルタイムでプロンプト一覧に反映される仕組みの構築
- [x] 音声認識の権限エラー（not-allowed）発生時のユーザーへの通知機能
  - [x] エラータイプを受け取るコールバック設計を実装
  - [x] 権限エラー発生時の専用ダイアログを表示する機能を追加
- [x] 起動時に無限ループが発生する問題の修正
  - [x] 重複したストレージ変更リスナーの削除
  - [x] Reactコンポーネントの依存配列の適切な設定
  - [x] フロントエンドストアの参照を安全に扱うための修正

### 解決済み
- [x] バックエンドからフロントエンドへのプロンプト情報伝達の問題修正
  - [x] PromptHandler.tsxのメニューボタン追加機能のバグ修正
  - [x] storeRefの更新タイミングの問題対応
  - [x] プロンプトメニュー表示時のデータ取得ロジック改善
  - [x] ポップアップで追加したプロンプトがメニューに表示されない問題の修正

### 未解決

- [ ] LocalLLM 接続機能の拡張
- [ ] プロンプトのカテゴリ分け
- [ ] プロンプトのインポート/エクスポート機能
- [ ] 複数言語対応
- [ ] Reactコンポーネントのテーマ切り替え機能
