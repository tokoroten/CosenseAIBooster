# CosenseAIBooster 開発 TODO リスト

## 割り込みTODO

- [x] 設定画面の見直し
  - [x] ダイアログの横幅が狭いので、横幅を広げる
  - [x] 同じ内容がヘッダに多重に表示されているので、ヘッダを削除する
  - [x] APIキーを検証するボタンを置く
  - [ ] 個別のプロンプトに対しては、モデル選択は、現在のLLMのプロバイダーを考慮して、モデルを表示するようにして。　→　現状は全体設定依存。今後の拡張候補として保留
  - [ ] テキストの挿入位置は、各プロンプト事に設定できるようにする　→　現状は全体設定依存。今後の拡張候補として保留
  - [x] ポップアップメニューから直接設定画面を開けるように変更

- [x] OpenAIのプロンプト構造の変更
  - [x] 登録したプロンプトをシステムプロンプトとして使用し、選択テキストをユーザープロンプトとして使用するよう変更
  - [x] API呼び出し時のmessages構造を変更
  - [x] ダイアログにシステムプロンプトとユーザープロンプトの情報を表示

- [x] ポップアップメニュー内のボタンの変更
  - [x] 実験用のAI Boosterボタンを削除
  - [x] 代わりに登録プロンプトごとの個別ボタンを表示

- 各種設定やAPI Keyを永続化するようにして。

- マイク入力ボタンの実装
  - 右側にマイクボタンを設置、クリックで音声入力を開始する
  - 音声入力中は、マイクボタンの色を変える
  - 音声入力中は、音声認識の結果をリアルタイムで表示し、確定したタイミングで、textareaのカーソルがある位置に挿入する
    - リアルタイムの表示は、カーソル位置に対してオーバーレイで表示する
  

## 対応中
- [x] トップレベルに多くのファイルが転がりすぎているので、フォルダ構造を整理する
  - [x] 不要なファイル（wxt.config.ts.new等）の削除
  - [x] 重複している出力ディレクトリ（dev/.output）の削除
  - [x] srcフォルダ内のコード整理
  - [x] プロジェクト構造を詳細にドキュメント化（knowledge/project-structure.md）
- [x] WXTの作法に従って、過去に作成されたコードを整理していって（src配下は整理済み、トップレベル整理も完了）
- [x] README.mdにビルドの方法と簡易な使い方を書いていく
- [ ] 実験用のボタンを追加して、動作確認をして
- [x] 設定画面のデザインをTailwindでカッコよくして。

- [x] 音声認識の言語を選択可能にする（英語など）
- [x] React、JSX、Tailwind、Zustandを使用してリファクタリング
  - [x] Zustandストアの実装
  - [x] ReactコンポーネントでUIを再実装
  - [x] Reactフレンドリーなユーティリティクラスの作成
- [x] Scrapboxのページメニューに新しいドロップダウンやボタンを追加するユーティリティクラスを作成する
  - [x] 既存のページメニュー（右側のボタン群）と同じスタイルで表示できること
  - [x] ドロップダウンメニュー追加機能
  - [x] 単独ボタン追加機能
  - [x] アイコン付きメニュー項目追加機能
- [x] テキスト選択時のポップアップメニューに機能を追加するためのユーティリティクラスを作成する
  - [x] ポップアップメニューの検出機能
  - [x] ボタン追加機能
  - [x] カスタムスタイルのサポート
  - [x] リムーブ機能

## 初期セットアップ
- [x] プロジェクトの初期化 (package.json の作成)
- [x] TypeScript の設定 (tsconfig.json)
- [x] ESLint と Prettier の設定
- [x] Chrome 拡張機能のマニフェストファイル (v3) の作成
- [x] ビルドスクリプトの設定 (Webpack)
- [x] プロジェクトディレクトリ構造の作成 (src/, dist/)

## 基本構造の実装
- [x] 拡張機能のアイコンの作成
  - [x] 複数サイズのアイコン (16x16, 32x32, 48x48, 128x128) の作成
- [x] バックグラウンドスクリプトの作成
- [x] コンテンツスクリプトの作成
- [x] Cosense (Scrapbox) ページ検出ロジックの実装
- [x] 右側のアイコン欄へのUI追加機能の実装

## 設定画面の実装
- [x] 設定ページのHTML/CSSの作成
  - [x] Reactコンポーネント化
  - [x] Tailwind CSSによるスタイリング
- [x] ポップアップメニューからの設定アクセス
  - [x] ポップアップ内で設定パネルを直接表示
  - [x] 設定パネルに`isPopup`プロパティを追加し、コンパクト表示に対応
  - [x] レイアウトとサイズの最適化
- [x] プロンプト管理機能の実装
  - [x] プロンプトの追加機能
  - [x] プロンプトの編集機能
  - [x] プロンプトの削除機能
  - [x] プロンプトの保存機能
  - [x] Zustandストアによる状態管理
- [x] プロンプト適用方法の設定
  - [x] 挿入位置設定 (選択範囲の下 or ページの最下部)
  - [x] モデル選択機能の実装
- [x] 音声入力言語設定の実装
- [x] API設定の実装
  - [x] OpenAI APIキー設定
  - [x] OpenRouter APIキー設定
  - [x] カスタムエンドポイント設定
  - [x] LocalLLM 接続設定（オプション）
- [x] 設定の保存と読み込み機能の実装
  - [x] Zustandストアと統合したChrome Storage API利用
  - [x] persistミドルウェアによる永続化

## 音声入力機能の実装
- [x] WebSpeech API を使用した音声認識の実装
  - [x] Reactフレンドリーなラッパーの作成
  - [x] Zustandストアと統合
- [x] 音声入力UIの作成 (マイクアイコン、状態表示)
  - [x] Reactコンポーネントとして実装
  - [x] Tailwind CSSによるスタイリング
- [x] 音声テキストの Cosense への挿入機能
- [x] 音声認識言語の切り替え機能

## プロンプト適用機能の実装
- [x] テキスト選択検出機能の実装
  - [x] Reactイベントハンドリングの統合
- [x] コンテキストメニューの実装
  - [x] 登録済みプロンプトのメニュー表示
  - [x] Reactベースのポップアップメニューコンポーネント
  - [x] プロンプト選択機能
- [x] 選択テキストとプロンプトの処理ロジック実装
  - [x] Zustandストアからのプロンプト取得
- [x] API 呼び出しの実装
  - [x] OpenAI API クライアント
  - [x] OpenRouter API クライアント
  - [x] カスタムエンドポイントクライアント
  - [x] ZustandストアからのAPI設定取得
- [x] 結果の挿入機能の実装
  - [x] 選択範囲の下への挿入ロジック
  - [x] ページ最下部への挿入ロジック
  - [x] Reactフレンドリーなドキュメント操作

## テストとデバッグ
- [x] 音声認識機能の強化
  - [x] 自動再起動機能の実装
  - [x] 一時停止検出機能の実装
  - [x] エラーハンドリングの改善
- [x] テキスト挿入機能の強化
  - [x] 複数行のテキスト挿入対応
  - [x] エディタへの挿入ロジックの改善
- [x] ストレージ関連のバグ修正
  - [x] `StorageService.get is not a function` エラーの修正
  - [x] `Invalid settings detected, using defaults` メッセージの問題修正
  - [x] TypeScriptの構文エラーの修正
- [x] Reactコンポーネントのテスト
  - [x] 不要なファイルの削除
  - [ ] コンポーネントのレンダリングテスト
  - [ ] 状態管理の動作確認
- [ ] ページメニューのユーティリティクラス機能確認
  - [ ] ReactベースのドロップダウンUIコンポーネントのテスト
  - [ ] Reactボタンコンポーネントのテスト
  - [ ] Reactメニュー項目コンポーネントのテスト
  - [ ] Tailwind CSSスタイルの調整とUI整合性確認
- [ ] 各機能の単体テスト
- [ ] 統合テスト
- [ ] Cosense サイト上での動作確認
- [ ] 様々なブラウザ環境でのテスト

## パッケージングとリリース
- [ ] パッケージングスクリプトの作成
- [ ] Chrome ウェブストアへの公開準備
- [ ] ドキュメント作成
  - [ ] Reactコンポーネントの構造に関するドキュメント
  - [ ] Zustandストアの使用法に関するドキュメント

## 追加機能 (オプション)
- [ ] LocalLLM 接続機能の拡張
- [ ] プロンプトのカテゴリ分け
- [ ] プロンプトのインポート/エクスポート機能
- [ ] 複数言語対応
- [ ] Reactコンポーネントのテーマ切り替え機能
- [ ] カスタムフック作成によるロジック改善
- [x] APIキーセキュリティの強化\n  - [x] APIキーをバックグラウンドスクリプトでのみ扱うよう変更\n  - [x] メッセージパッシングを利用したセキュアな通信の実装\n  - [x] コンテンツスクリプトでAPIキーを扱わないように修正
